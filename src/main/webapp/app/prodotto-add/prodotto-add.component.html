<div class="pa-page">
  <div class="pa-inner">
    <!-- Header -->
    <div class="pa-header">
      <h1>üçΩÔ∏è Gestione Prodotti</h1>
      <p>Aggiungi i piatti al tuo menu</p>
    </div>

    <div *ngIf="isLoadingInit" class="pa-loading">
      <div class="pa-spinner"></div>
      <span>Caricamento...</span>
    </div>

    <div *ngIf="!isLoadingInit" class="pa-layout">
      <!-- COLONNA SINISTRA: Form -->
      <div class="pa-card">
        <!-- Selezione menu e portata -->
        <div *ngIf="!portataPreimpostata" class="pa-section">
          <h2 class="pa-section-title">üìã Seleziona dove aggiungere</h2>

          <div class="pa-form-group">
            <label class="pa-form-label">Menu *</label>
            <select class="pa-form-control" [(ngModel)]="menuSelezionatoId" (ngModelChange)="onMenuSelezionato()">
              <option [ngValue]="null">-- Scegli un menu --</option>
              <option *ngFor="let m of menus" [value]="m.id">{{ m.nome }}</option>
            </select>
          </div>

          <div class="pa-form-group" *ngIf="portate.length > 0">
            <label class="pa-form-label">Portata *</label>
            <select class="pa-form-control" [(ngModel)]="portataSelezionataId" (ngModelChange)="onPortataSelezionata()">
              <option [ngValue]="null">-- Scegli una portata --</option>
              <option *ngFor="let p of portate" [value]="p.id">{{ nomePortata(p) }}</option>
            </select>
          </div>
        </div>

        <!-- Form prodotto -->
        <div class="pa-section" *ngIf="portataSelezionataId">
          <h2 class="pa-section-title">‚ûï Nuovo Prodotto</h2>

          <div *ngIf="successMessage" class="pa-alert pa-alert-success">{{ successMessage }}</div>
          <div *ngIf="errorMessage" class="pa-alert pa-alert-error">{{ errorMessage }}</div>

          <div class="pa-form-group">
            <label class="pa-form-label">Nome *</label>
            <input type="text" class="pa-form-control" [(ngModel)]="nome" placeholder="es. Spaghetti alla carbonara" maxlength="100" />
          </div>

          <div class="pa-form-group">
            <label class="pa-form-label">Descrizione</label>
            <textarea class="pa-form-control" [(ngModel)]="descrizione" rows="2" placeholder="Ingredienti, note o varianti..."></textarea>
          </div>

          <div class="pa-form-group">
            <label class="pa-form-label">Prezzo (‚Ç¨) *</label>
            <input type="number" class="pa-form-control" [(ngModel)]="prezzo" placeholder="0.00" min="0" step="0.50" />
          </div>

          <!-- Allergeni -->
          <div class="pa-form-group" *ngIf="allergeniDisponibili.length > 0">
            <label class="pa-form-label">Allergeni</label>
            <p class="pa-allergeni-hint">Clicca per selezionare/deselezionare gli allergeni</p>
            <div class="pa-allergeni-grid">
              <div
                *ngFor="let a of allergeniDisponibili"
                class="pa-allergene-chip"
                [class.selected]="allergeniSelezionati.has(a.id)"
                [style.borderColor]="allergeniSelezionati.has(a.id) ? a.colore || '#c8102e' : ''"
                (click)="toggleAllergene(a.id)"
              >
                <div class="pa-allergene-icona" [style.backgroundColor]="a.colore || '#888'">
                  <img
                    *ngIf="a.icona && a.iconaContentType"
                    [src]="'data:' + a.iconaContentType + ';base64,' + a.icona"
                    [alt]="a.nome"
                    class="pa-allergene-img"
                  />
                  <span *ngIf="!a.icona" class="pa-allergene-iniziale">{{ a.nome.charAt(0) }}</span>
                </div>
                {{ a.nome }}
              </div>
            </div>
            <div class="pa-custom-row">
              <input
                type="text"
                class="pa-form-control"
                [(ngModel)]="nomeAllergeneCustom"
                placeholder="Allergene personalizzato..."
                style="flex: 1"
              />
              <button class="pa-btn-custom" (click)="aggiungiAllergeneCustom()" type="button">+ Aggiungi</button>
            </div>
          </div>

          <button class="pa-btn-aggiungi" (click)="aggiungiProdotto()" [disabled]="!formValido() || isSaving">
            {{ isSaving ? 'Salvataggio...' : '+ Aggiungi Prodotto' }}
          </button>
        </div>
      </div>

      <!-- COLONNA DESTRA: Lista prodotti aggiunti -->
      <div class="pa-card">
        <div class="pa-lista-header">
          <h2>
            Prodotti aggiunti <span class="pa-count-badge">{{ prodottiAggiunti.length }}</span>
          </h2>
        </div>

        <div *ngIf="prodottiAggiunti.length === 0" class="pa-lista-empty">Nessun prodotto aggiunto ancora</div>

        <div *ngFor="let p of prodottiAggiunti" class="pa-prodotto-item">
          <div class="pa-prodotto-info">
            <span class="pa-prodotto-nome">{{ p.nome }}</span>
            <span class="pa-prodotto-desc" *ngIf="p.descrizione">{{ p.descrizione }}</span>
          </div>
          <div class="pa-prodotto-meta">
            <span class="pa-prodotto-prezzo">{{ formatPrezzo(p.prezzo) }}</span>

            <!-- Allergeni mini -->
            <div class="pa-prodotto-allergeni" *ngIf="p.allergenis && p.allergenis.length > 0">
              <ng-container *ngFor="let a of p.allergenis">
                <div class="pa-lista-cerchio" [style.backgroundColor]="a.colore || '#888'" [title]="a.nome">
                  <img
                    *ngIf="a.icona && a.iconaContentType"
                    [src]="'data:' + a.iconaContentType + ';base64,' + a.icona"
                    [alt]="a.nome"
                    class="pa-lista-img"
                  />
                  <span *ngIf="!a.icona || a.isCustom" class="pa-lista-iniziale">
                    <img *ngIf="a.isCustom" src="/content/images/allergene-custom.png" [alt]="a.nome" class="pa-lista-img" />
                    <span *ngIf="!a.isCustom && !a.icona">{{ a.nome.charAt(0) }}</span>
                  </span>
                </div>
              </ng-container>
            </div>

            <button class="pa-btn-elimina" (click)="eliminaProdotto(p.id)">
              <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="3 6 5 6 21 6" />
                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6" />
              </svg>
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

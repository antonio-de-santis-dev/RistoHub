<div class="ml-page">
  <div class="ml-inner">
    <!-- Header -->
    <div class="ml-header">
      <div class="ml-header-left">
        <h1>I miei Menu</h1>
        <p>{{ menus.length }} menu creati</p>
      </div>
      <button class="btn-crea" routerLink="/menu-wizard">
        <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
          <line x1="12" y1="5" x2="12" y2="19" />
          <line x1="5" y1="12" x2="19" y2="12" />
        </svg>
        Crea Menu
      </button>
    </div>

    <!-- Loading -->
    @if (isLoading) {
      <div class="ml-loading">
        <div class="ml-spinner"></div>
        <span>Caricamento menu...</span>
      </div>
    }

    <!-- Empty -->
    @else if (menus.length === 0) {
      <div class="ml-empty">
        <span class="ml-empty-icon">üçΩÔ∏è</span>
        <h3>Nessun menu ancora creato</h3>
        <p>Crea il tuo primo menu digitale e condividilo con i clienti tramite QR Code.</p>
        <button class="btn-crea" routerLink="/menu-wizard">Crea il tuo primo menu</button>
      </div>
    }

    <!-- Grid -->
    @else {
      <div class="ml-grid">
        @for (menu of menus; track menu.id) {
          <div class="ml-card" [class.ml-card-inattivo]="!menu.attivo">
            <div class="ml-card-bar" [style.background]="menu.colorePrimario ?? '#c8102e'"></div>

            <div class="ml-card-body">
              <div class="ml-card-top">
                <h2>{{ menu.nome }}</h2>
                <button
                  class="btn-toggle-attivo"
                  [class.is-attivo]="menu.attivo"
                  [class.is-inattivo]="!menu.attivo"
                  [disabled]="toggling === menu.id"
                  (click)="toggleAttivo(menu)"
                  [title]="menu.attivo ? 'Clicca per disattivare' : 'Clicca per attivare'"
                >
                  <span class="toggle-dot"></span>
                  <span>
                    @if (toggling === menu.id) {
                      ‚è≥
                    } @else {
                      {{ menu.attivo ? 'Attivo' : 'Inattivo' }}
                    }
                  </span>
                </button>
              </div>

              @if (menu.descrizione) {
                <p class="ml-card-desc">{{ menu.descrizione }}</p>
              }

              <div class="ml-card-meta">
                <span class="ml-template-badge">{{ templateLabel(menu.templateStyle) }}</span>
                @if (!menu.attivo) {
                  <span class="ml-inattivo-hint">üîí Non visibile</span>
                }
                @if (haCarosello(menu)) {
                  <span class="ml-carosello-badge">üñºÔ∏è Carosello</span>
                }
              </div>
            </div>

            <div class="ml-card-actions" [class.ml-card-actions-5]="haCarosello(menu)">
              <button class="ml-btn ml-btn-view" (click)="visualizza(menu.id)">
                <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z" />
                  <circle cx="12" cy="12" r="3" />
                </svg>
                Visualizza
              </button>
              <button class="ml-btn ml-btn-edit" (click)="modifica(menu.id)">
                <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7" />
                  <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z" />
                </svg>
                Modifica
              </button>
              <button class="ml-btn ml-btn-qr" (click)="mostraQr(menu.id)">
                <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <rect x="3" y="3" width="5" height="5" />
                  <rect x="16" y="3" width="5" height="5" />
                  <rect x="3" y="16" width="5" height="5" />
                  <path d="M21 16h-3a2 2 0 0 0-2 2v3" />
                  <path d="M21 21v.01" />
                </svg>
                QR Code
              </button>

              <!-- ‚îÄ‚îÄ Pulsante Copertina (solo template con carosello) ‚îÄ‚îÄ -->
              @if (haCarosello(menu)) {
                <button class="ml-btn ml-btn-cover" (click)="modificaCopertina(menu.id)" title="Gestisci immagini del carosello">
                  <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="3" y="3" width="18" height="18" rx="3" />
                    <circle cx="8.5" cy="8.5" r="1.5" />
                    <polyline points="21 15 16 10 5 21" />
                  </svg>
                  Copertina
                </button>
              }

              <button class="ml-btn ml-btn-delete" (click)="chiediConfermaElimina(menu)">
                <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <polyline points="3 6 5 6 21 6" />
                  <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a1 1 0 0 1 1-1h4a1 1 0 0 1 1 1v2" />
                </svg>
                Elimina
              </button>
            </div>
          </div>
        }
      </div>
    }
  </div>
</div>

<!-- Modal Conferma Eliminazione -->
@if (confermaEliminazioneVisibile) {
  <div class="rh-modal-overlay" (click)="annullaElimina()">
    <div class="rh-modal-box" (click)="$event.stopPropagation()">
      <div class="rh-modal-icon">üóëÔ∏è</div>
      <h3>Elimina menu</h3>
      <p>
        Sei sicuro di voler eliminare <strong style="color: #fff">{{ menuDaEliminare?.nome }}</strong
        >?<br />L'operazione non √® reversibile.
      </p>
      <div class="rh-modal-actions">
        <button class="btn-annulla" (click)="annullaElimina()">Annulla</button>
        <button class="btn-conferma-elimina" (click)="confermaElimina()">Elimina</button>
      </div>
    </div>
  </div>
}

<!-- Modal QR -->
@if (qrVisible) {
  <div class="rh-modal-overlay" (click)="chiudiQr()">
    <div class="rh-modal-box rh-modal-qr" (click)="$event.stopPropagation()">
      <div class="rh-modal-icon">üì±</div>
      <h3>QR Code del Menu</h3>
      <p class="qr-subtitle">I clienti scansionano questo codice per visualizzare il menu</p>
      <div class="qr-image-wrap">
        <img [src]="qrImageUrl" alt="QR Code" class="qr-image" />
      </div>
      <p class="qr-link">{{ qrUrl }}</p>
      <div class="rh-modal-actions">
        <a [href]="qrImageUrl" download="qr-menu.png" class="btn-download">‚¨á Scarica QR</a>
        <button class="btn-annulla" (click)="chiudiQr()">Chiudi</button>
      </div>
    </div>
  </div>
}

<!-- Toast -->
@if (toastMsg) {
  <div class="rh-toast" [class.rh-toast-success]="toastType === 'success'" [class.rh-toast-error]="toastType === 'error'">
    {{ toastMsg }}
  </div>
}

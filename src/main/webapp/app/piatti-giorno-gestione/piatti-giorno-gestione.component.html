<div class="pg-page">
  <div class="pg-inner">
    <div class="pg-header">
      <div class="pg-header-left">
        <h1>‚ú® Piatti del Giorno</h1>
        <p>Gestisci i piatti speciali visibili nel menu</p>
      </div>
      <div class="pg-header-actions">
        <button class="btn-crea" (click)="apriModaleCrea()">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
            <line x1="12" y1="5" x2="12" y2="19" />
            <line x1="5" y1="12" x2="19" y2="12" />
          </svg>
          Crea Nuovo
        </button>
        <button class="btn-seleziona" (click)="apriModaleSeleziona()">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71" />
            <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71" />
          </svg>
          Da Menu
        </button>
      </div>
    </div>

    <div *ngIf="isLoading" class="pg-loading">
      <div class="pg-spinner"></div>
      <span>Caricamento piatti...</span>
    </div>

    <div *ngIf="!isLoading && piattiGiorno.length === 0" class="pg-empty">
      <span class="pg-empty-icon">üçΩÔ∏è</span>
      <h3>Nessun piatto del giorno</h3>
      <p>Crea un nuovo piatto speciale o selezionane uno dal menu esistente</p>
    </div>

    <div *ngIf="!isLoading && piattiGiorno.length > 0" class="pg-grid">
      <div *ngFor="let piatto of piattiGiorno" class="pg-card" [class.pg-card-inattivo]="!piatto.attivo">
        <div class="pg-card-bar" [style.background]="piatto.attivo ? '#4ade80' : '#e5e7eb'"></div>
        <div class="pg-card-badge-row">
          <span class="pg-badge pg-badge-menu" *ngIf="piatto.prodotto">üîó Da Menu</span>
          <span class="pg-badge pg-badge-custom" *ngIf="!piatto.prodotto">‚ú® Personalizzato</span>
          <span class="pg-menu-nome" *ngIf="piatto.menu?.nome">{{ piatto.menu?.nome }}</span>
        </div>
        <div class="pg-card-body">
          <h3 class="pg-nome">{{ nomePiatto(piatto) }}</h3>
          <p class="pg-desc" *ngIf="descrizionePiatto(piatto)">{{ descrizionePiatto(piatto) }}</p>
          <div class="pg-prezzo">{{ formatPrezzo(prezzoPiatto(piatto)) }}</div>
          <div class="pg-allergeni" *ngIf="getAllergeniPiatto(piatto).length > 0">
            <ng-container *ngFor="let a of getAllergeniPiatto(piatto)">
              <div class="pg-all-cerchio" [style.backgroundColor]="a.colore || '#888'" [title]="a.nome">
                <img
                  *ngIf="a.icona && a.iconaContentType"
                  [src]="'data:' + a.iconaContentType + ';base64,' + a.icona"
                  [alt]="a.nome"
                  class="pg-all-img"
                />
                <span *ngIf="!a.icona" class="pg-all-iniziale">{{ a.nome.charAt(0) }}</span>
              </div>
            </ng-container>
          </div>
        </div>
        <div class="pg-card-actions">
          <button
            class="pg-btn-toggle"
            [class.pg-visibile]="piatto.attivo"
            [class.pg-nascosto]="!piatto.attivo"
            (click)="toggleAttivo(piatto)"
          >
            <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z" />
              <circle cx="12" cy="12" r="3" />
            </svg>
            {{ piatto.attivo ? 'Visibile' : 'Nascosto' }}
          </button>
          <button class="pg-btn-delete" (click)="eliminaPiatto(piatto.id!)" title="Elimina">
            <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="3 6 5 6 21 6" />
              <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a1 1 0 0 1 1-1h4a1 1 0 0 1 1 1v2" />
            </svg>
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Footer -->
  <footer class="pg-footer">
    <p>¬© 2025 <strong>RistoHub</strong> ‚Äî Il tuo menu digitale professionale</p>
  </footer>
</div>

<!-- Modal: Crea Nuovo -->
<div *ngIf="modaleCreazioneAperto && !modalitaSelezioneProdotto" class="pg-modal-overlay" (click)="chiudiModale()">
  <div class="pg-modal-box" (click)="$event.stopPropagation()">
    <h2 class="pg-modal-title">‚ú® Nuovo Piatto del Giorno</h2>
    <div *ngIf="successMessage" class="pg-alert pg-alert-success">{{ successMessage }}</div>
    <div *ngIf="errorMessage" class="pg-alert pg-alert-error">{{ errorMessage }}</div>
    <div class="pg-form-group">
      <label class="pg-form-label">Associa a un Menu</label>
      <select class="pg-form-control" [(ngModel)]="menuNuovoPiatto">
        <option [ngValue]="null">-- Nessun menu --</option>
        <option *ngFor="let m of menus" [value]="m.id">{{ m.nome }}</option>
      </select>
    </div>
    <div class="pg-form-group">
      <label class="pg-form-label">Nome *</label>
      <input type="text" class="pg-form-control" [(ngModel)]="nome" placeholder="es. Tagliolini al tartufo" maxlength="100" />
    </div>
    <div class="pg-form-group">
      <label class="pg-form-label">Descrizione</label>
      <textarea class="pg-form-control" [(ngModel)]="descrizione" rows="2" placeholder="Ingredienti, note..."></textarea>
    </div>
    <div class="pg-form-group">
      <label class="pg-form-label">Prezzo (‚Ç¨) *</label>
      <input type="number" class="pg-form-control" [(ngModel)]="prezzo" placeholder="0.00" min="0" step="0.50" />
    </div>
    <div class="pg-form-group" *ngIf="allergeniDisponibili.length > 0">
      <label class="pg-form-label">Allergeni</label>
      <p class="pg-allergeni-hint">Clicca per selezionare/deselezionare</p>
      <div class="pg-allergeni-grid">
        <div
          *ngFor="let a of allergeniDisponibili"
          class="pg-allergene-chip"
          [class.selected]="allergeniSelezionati.has(a.id)"
          (click)="toggleAllergene(a.id)"
        >
          <div class="pg-allergene-icona" [style.backgroundColor]="a.colore || '#888'">
            <img
              *ngIf="a.icona && a.iconaContentType"
              [src]="'data:' + a.iconaContentType + ';base64,' + a.icona"
              [alt]="a.nome"
              class="pg-allergene-img"
            />
            <span *ngIf="!a.icona" class="pg-allergene-iniziale">{{ a.nome.charAt(0) }}</span>
          </div>
          {{ a.nome }}
        </div>
      </div>
      <div class="pg-custom-row">
        <input
          type="text"
          class="pg-form-control"
          [(ngModel)]="nomeAllergeneCustom"
          placeholder="Allergene personalizzato..."
          style="flex: 1"
        />
        <button class="pg-btn-custom" (click)="aggiungiAllergeneCustom()" type="button">+ Aggiungi</button>
      </div>
    </div>
    <div class="pg-modal-actions">
      <button class="pg-btn-cancel" (click)="chiudiModale()">Annulla</button>
      <button class="pg-btn-save" (click)="salvaPiatto()" [disabled]="isSaving">
        {{ isSaving ? 'Salvataggio...' : 'Salva Piatto' }}
      </button>
    </div>
  </div>
</div>

<!-- Modal: Seleziona da Menu -->
<div *ngIf="modaleCreazioneAperto && modalitaSelezioneProdotto" class="pg-modal-overlay" (click)="chiudiModale()">
  <div class="pg-modal-box" (click)="$event.stopPropagation()">
    <h2 class="pg-modal-title">üîó Seleziona da Menu</h2>
    <div class="pg-form-group">
      <label class="pg-form-label">Menu</label>
      <select class="pg-form-control" [(ngModel)]="menuSelezionato" (ngModelChange)="onMenuSelezionato()">
        <option [ngValue]="null">-- Scegli un menu --</option>
        <option *ngFor="let m of menus" [value]="m.id">{{ m.nome }}</option>
      </select>
    </div>
    <div class="pg-form-group" *ngIf="portate.length > 0">
      <label class="pg-form-label">Portata</label>
      <select class="pg-form-control" [(ngModel)]="portataSelezionata" (ngModelChange)="onPortataSelezionata()">
        <option [ngValue]="null">-- Scegli una portata --</option>
        <option *ngFor="let p of portate" [value]="p.id">{{ p.nomePersonalizzato ?? p.nomeDefault }}</option>
      </select>
    </div>
    <div *ngIf="prodotti.length > 0">
      <label class="pg-form-label">Prodotti disponibili</label>
      <div class="pg-prodotto-item" *ngFor="let prod of prodotti" (click)="prodottoSelezionato = prod.id; salvaPiatto()">
        <span class="pg-prodotto-nome">{{ prod.nome }}</span>
        <span class="pg-prodotto-prezzo">{{ formatPrezzo(prod.prezzo) }}</span>
      </div>
    </div>
    <div class="pg-modal-actions">
      <button class="pg-btn-cancel" (click)="chiudiModale()">Chiudi</button>
    </div>
  </div>
</div>
